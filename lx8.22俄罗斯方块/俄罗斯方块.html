<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style type="text/css">
		#canvas{
			background-color: black;
			position: absolute;
			top: 0px;
			left: 0px;
			right: 0px;
			bottom: 0px;
			margin: auto;
		}
	</style>
</head>
<body>
	<canvas width="500" height="500" id="canvas"></canvas>
	<script type="text/javascript">
		var canvas=document.getElementById("canvas");
		//获取绘制对象
		var gc=canvas.getContext("2d");
		//创建数据
		var data=map(12,12);
		
		var y=0;//指方块向下移动的次数
		var matrix=mold();

		//画面板
		render(data,gc);
		

		setInterval(function(){
			fall();
		}, 400);

		create(matrix);

		//移动
		function fall(){
			//判断当前这个小方块，如果移动到了最底部就定下，并且要重新生成一个小方块
			if(touchTest()){
				y=0;
				matrix=mold();
			}
			//并且清除上一行的数据
			clearPre(matrix);
			//如果没有，则向下移动
			y++;
			create(matrix);
		}

		//除了检测到达底部之外，还要检测是否与其他的方块碰撞
		function touchTest(){
			var len=matrix.length;
			if(y+len>=data.length){
				return true;
			}
			for(var i=len-1;i<len;i++){
				for(var j=0;j<matrix[i].length;j++){
					//如果它下面的数据为1,那么就说明下面有方块，直接返回true;
					if(matrix[i][j]&&data[i+y+1][j+4]==1){
						return true;
					}
				}
			}
			return false;
		}

		//清除
		function clearPre(arr){
			for(var i=0;i<arr.length;i++){
				for(var j=0;j<arr[i].length;j++){
					data[i+y][j+4]=0;
				}
			}
		}

		//画出来，小方块
		function create(arr){
			for(var i=0;i<arr.length;i++){
				for(var j=0;j<arr[i].length;j++){
					data[i+y][j+4]=arr[i][j];
				}
			}
			render(data,gc);
		}
		function down(){

		}
		//开始绘制面板
		function render(data,gc){
			//为什么要减10  10的间隙
			var w=500/12-10;
			var h=w;

			var rLen=data.length;
			var cLen=data[0].length;

			for(var i=0;i<rLen;i++){
				for(var j=0;j<cLen;j++){
					//开始画小格子
					gc.fillStyle=data[i][j]==0?"pink":"yellow";
					gc.fillRect(j*(w+10)+5,i*(h+10)+5,w,h);
				}
			}
		}
		//给地图定义数据
		//如果小格子的数据为0 则代表没有 如果为1，则代表方块
		
		//开始绘制面板
		function mold(){
			var num=Math.floor( Math.random()*7);
			var arr=[
				[[1,1,1,1]],
				[[1,1],[1,1]],
				[[1,1,0],[0,1,1]],
				[[1,0,0],[1,1,1]],
				[[0,1,1],[1,1,0]],
				[[0,1,0],[1,1,1]],
				[[0,0,1],[1,1,1]]
			];
			//随机生成一个方块
			return arr[num];
		}
		
		//创建数据
		function map(r,c){
			var data=[];
			for(var i=0;i<r;i++){
				data.push([]);
				//地图最开始的时候应该是空白的，没有方块，所有的数据都应该是0
				for(var j=0;j<c;j++){
					data[i].push(0);
				}
			}
			return data;
		}
	</script>
</body>
</html>